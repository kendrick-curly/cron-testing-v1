name: Google Chat Alerts

on:
  workflow_dispatch:
  push:

jobs:
  check-testing-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout testing branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0   # needed for tag and history checks
          lfs: true


      # - name: Check if commit has a tag
      #   id: tagcheck
      #   run: |
      #     if git describe --tags --exact-match >/dev/null 2>&1; then
      #       TAG=$(git describe --tags --exact-match)
      #       echo "Found tag: $TAG ${{github.ref_name}}"
      #     else
      #       echo "::error::‚ùå ${{github.ref_name}} This commit has NO TAG. Builds require a tag when using versioning: Tag."
      #       exit 1
      #     fi
       
      # - name: testing
      #   id: sasd
      #   run: echo "test"

      - name: Get PR descriptions between latest and second latest commit
        id: get-pr-descriptions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest commit hash (HEAD)
          LATEST_COMMIT=$(git rev-parse HEAD)
          echo "Latest commit: $LATEST_COMMIT"

          # Get the second latest commit hash (HEAD~1)
          SECOND_LATEST_COMMIT=$(git rev-parse HEAD~1)
          echo "Second latest commit: $SECOND_LATEST_COMMIT"

          # Get all commits between second latest and latest (exclusive..inclusive)
          echo "Fetching commits between $SECOND_LATEST_COMMIT and $LATEST_COMMIT..."
          COMMITS=$(git rev-list $SECOND_LATEST_COMMIT..$LATEST_COMMIT)

          # Extract repository owner and name from GITHUB_REPOSITORY
          REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          echo "Repository: $REPO_OWNER/$REPO_NAME"

          # Loop through each commit and find associated PRs
          echo "=== PR Descriptions ==="
          for commit in $COMMITS; do
            echo "Checking commit: $commit"

            # Use GitHub API to get PRs associated with this specific commit
            # This endpoint returns all PRs that include this commit
            PRS=$(gh api "/repos/$REPO_OWNER/$REPO_NAME/commits/$commit/pulls" \
              --jq '.[] | select(.merged_at != null) | "PR #\(.number): \(.title)\nDescription: \(.body // "No description provided")\nMerged at: \(.merged_at)\n---"')

            if [ -n "$PRS" ]; then
              echo "$PRS"
            else
              echo "No merged PR found for commit $commit"
            fi
            echo ""
          done
